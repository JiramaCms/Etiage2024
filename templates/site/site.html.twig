{% extends 'base.html.twig' %}

{% block title %}Hello LocationController!{% endblock %}

{% block menuactive %}map{% endblock %}

{% block body %}
    <style>
        /* Styles for the sidebar */
        #map {
            position: relative;
            height: 500px; 
        }
        .legend {
            background: white;
            padding: 10px;
            border: 1px solid white;
            border-radius: 3px;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
            position: absolute;
            bottom: 18px;
            left: 18px;
            z-index: 1000;
        }
        .legend i {
            width: 15px;
            height: 15px;
            display: inline-block;
            margin-right: 8px;
            border-radius: 50%;
        }
        .legend .toggle-zones {
            cursor: pointer;
            text-decoration: none;
        }
        .legend .toggle-zones.strikethrough {
            text-decoration: line-through;
        }
        .sidebar-info {
            position: absolute;
            top: 0;
            right: 0;
            width: 350px;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.9); /* Semi-transparent */
            padding: 20px;
            box-shadow: -2px 0 5px rgba(0,0,0,0.5);
            overflow-y: auto;
            z-index: 1000;
            margin: 2px;
            border-radius: 15px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1); 
        }
        .hidden2 {
            display: none;
        }
        .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: transparent;
            border: none;
            font-size: 20px;
            cursor: pointer;
        }
        .marker-icon-jump {
        animation: jumpMarker 0.8s infinite alternate;
        }
        @keyframes jumpMarker {
            from {
                opacity: 1;
            }
            to {
                opacity: 0.3;
            }
        }
        
    </style>

    <div class="content">
        <div class="py-4 px-3 px-md-4">
            <div class="card mb-3 mb-md-4">
                <div class="card-body">
                    <!-- Breadcrumb -->
                    <nav class="d-none d-md-block" aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item">
                                <a href="/">Propriete</a>
                            </li>
                            <li class="breadcrumb-item active" aria-current="page">Detail</li>
                        </ol>
                    </nav>
                    <!-- End Breadcrumb -->

                    <div class="mb-3 mb-md-4 d-flex justify-content-between">
                        <div class="h3 mb-0">Descriptions</div>
                    </div>
                    <div id="map">
                        <!-- Div de la carte -->
                        <div class="sidebar-info hidden2" id="sidebar-info">
                            <button class="close-btn" onclick="closeSidebar()">×</button>
                            <ul class="nav nav-tabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="tabOverview" data-bs-toggle="tab" onclick="showOverview()"  aria-selected="true">
                                        Overview
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="tabIncident" data-bs-toggle="tab" onclick="showIncidents()"  aria-selected="false">
                                        Incidents
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="tabStatistique" data-bs-toggle="tab" onclick="showStatistics()"  aria-selected="false">
                                        Statistique
                                    </button>
                                </li>
                            </ul>
                            <h3>Details</h3>
                            <p id="sidebar-info-content"></p>
                        </div>
                    </div>
                    <div id="legend" class="legend">
                        <h4>Légende</h4>
                        <div><i style="background: blue;"></i> Site bleu</div>
                        <div><i style="background: green;"></i> Site vert</div>
                        <div><i style="background: orange;"></i> Site orange</div>
                        <div class="toggle-zones" onclick="toggleZonesVisibility()">Zones</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-fullscreen/dist/leaflet.fullscreen.css" />
    <script src="https://unpkg.com/leaflet-fullscreen/dist/Leaflet.fullscreen.min.js"></script>
    <script>
        var map = L.map('map').setView([-18.922647647936802, 47.46631766551795], 10);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Map data © <a href="https://openstreetmap.org">OpenStreetMap</a> contributors'
        }).addTo(map);

        var zones = {{ zone|raw }};
        let sitesData =  {{sites|raw}};
        //console.log(sitesData);
        var polygons = [];
        var zonesVisible = true;

        function showOverview(){
            var siteId = currentSelectedMarker;
            fetchSiteDetails(siteId);
        }

        function showIncidents() {
            var siteId = currentSelectedMarker;
            var siteData = sitesData.find(site => site.id === siteId);

            if (siteData && siteData.incidents.length >= 1) {
                let incidentInfo = siteData.incidents.map(incident => `
                    <div>Incident : ${incident.libelle}</div>
                    <div>Description : ${incident.description}</div>
                `).join('');
                document.getElementById('sidebar-info-content').innerHTML = incidentInfo;
            } else {
                document.getElementById('sidebar-info-content').innerHTML = 'Aucun incident trouvé.';
            }
        }

        function showStatistics() {
            // Logique pour afficher les statistiques dans le sidebar
            console.log('efa niova les statistiques');
            // Exemple : Mettre à jour le contenu du sidebar
            document.getElementById('sidebar-info-content').innerHTML = 'Contenu des statistiques dia mbola miampy';
        }

        //GET
        function fetchZoneDetails(zoneId) {
            fetch(`/site/liste/detailZone/${zoneId}`)
                .then(response => response.json())
                .then(data => {
                    let datas =JSON.parse(data);
                    var zoneData = zones.find(zone => zone.id === zoneId);
                    if (zoneData) {
                        showZoneSidebar(zoneData, datas);
                    }
                })
                .catch(error => console.error('Erreur:', error));
        }

        // Fonction pour ajouter les polygones à la carte
        function addPolygons(zones) {
            removePolygons();
            zones.forEach(function(zone) {
                var coordinates = zone.coord.map(function(coord) {
                    return [coord.latitude, coord.longitude];
                });
                var polygon = L.polygon(coordinates).addTo(map).bindPopup(zone.libelle);
                polygon.on('click', function(e) {
                    fetchZoneDetails(zone.id);
                    currentSelectedMarker = null;
                });

                polygons.push(polygon);
            });
        }

        function showZoneSidebar(zone,siteData) {

            let siteInfo = siteData.map(site => `
                <div>
                    <strong>nom : ${site.libelle}</strong><br>
                    Adresse : ${site.adresse}<br>
                    Etat : ${site.etat}
                </div>
            `   );

            let zoneInfo = `
                <div>
                    <strong><p>Zone : ${zone.libelle}</p>Zone->Site :->incident :->Action->Objectif :Materiel</strong>
                    Description : ${zone.description}
                    <p>Coordonnées : ${zone.coord.map(coord => `(${coord.latitude}, ${coord.longitude})`).join(', ')}</p>
                    Sites:
                    ${siteInfo}
                </div>
            `;
            sidebarContent.innerHTML = zoneInfo;
            sidebar.classList.remove('hidden2');
        }

        function removePolygons() {
            polygons.forEach(function(polygon) {
                map.removeLayer(polygon);
            });
            polygons = [];
        }

        function toggleZonesVisibility() {
            var toggleElement = document.querySelector('.toggle-zones');
            zonesVisible = !zonesVisible;
            if (zonesVisible) {
                addPolygons(zones);
                toggleElement.classList.remove('strikethrough');
            } else {
                removePolygons();
                toggleElement.classList.add('strikethrough');
            }
        }

        addPolygons(zones);


        var sidebar = document.getElementById('sidebar-info');
        var sidebarContent = document.getElementById('sidebar-info-content');
        var markers = [];
        var currentSelectedMarker = null;

        function closeSidebar() {
            sidebar.classList.add('hidden2');
            markers.forEach(function(m) {
                m.getElement().classList.remove('marker-icon-jump');
            });
        }
                
            
        var markers = [];

        // Fonction pour mettre à jour le contenu de la sidebar avec les données du site et de la zone
        function updateSidebarContent(siteData, zoneData) {

            if (!Array.isArray(zoneData)) {
                console.error('Les données de zones ne sont pas un tableau:', zoneData);
                return;
            }

                let zonesInfo = zoneData.map(zone => `
                <div>
                    <strong>Zone : ${zone.libelle}</strong><br>
                    Description : ${zone.description}
                </div>
            `   );

            sidebarContent.innerHTML = `
                <strong>Nom : ${siteData.libelle}</strong><br>
                Adresse : ${siteData.adresse}<br>
                Latitude : ${siteData.coord.latitude}<br>
                Longitude : ${siteData.coord.longitude}<br>
                ${zonesInfo}
            `;
            sidebar.classList.remove('hidden2');
        }

        // Fonction pour récupérer les détails de la zone par rapport à l'ID du site
        function fetchSiteDetails(siteId) {
            // Remplacez cette URL par l'URL de votre endpoint pour obtenir les détails de la zone
            fetch(`/site/liste/detailSite/${siteId}`)
                .then(response => response.json())
                .then(data => {
                    let datas =JSON.parse(data);
                    var siteData = sitesData.find(site => site.id === siteId);
                    if (siteData) {
                        updateSidebarContent(siteData, datas);
                    }
                })
                .catch(error => console.error('Erreur:', error));
        }

        // Affichage des sites
        sitesData.forEach(function(site) {
            var iconUrl = "/images/marker-green.svg";
            
            if (site.etat == '1') {
                iconUrl = "/images/marker-blue.svg";
            } else if (site.etat == '2') {
                iconUrl = "/images/marker-green.svg";
            } else if (site.etat == '3') {
                iconUrl = "/images/marker-orange.svg";
            }

            var markerIcon = L.icon({
                iconUrl: iconUrl,
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34]
            });

            // Affichage sur la carte
            var marker = L.marker([site.latitude, site.longitude], { icon: markerIcon }).addTo(map);
            markers.push(marker); // Ajoute le marqueur au tableau

            // Sur clic d'un point
            marker.on('click', function(e) {
                map.setView(e.latlng, 12); // Centre la carte sur le marqueur

                // Retirer l'animation de tous les autres marqueurs
                markers.forEach(function(m) {
                    m.getElement().classList.remove('marker-icon-jump');
                });

                // Appliquez l'animation au marqueur cliqué
                e.target.getElement().classList.add('marker-icon-jump');
                currentSelectedMarker = site.id;

                // Appelle la fonction pour récupérer les détails de la zone
                fetchSiteDetails(site.id);
            });
        });
        

        map.zoomControl.setPosition('bottomright');
    </script>
{% endblock %}
